#!/usr/bin/env bash

shopt -s extglob

[ $(uname) == "Darwin" ] && SED_FLAG='-l' || SED_FLAG='-u'

BUILD_DEBUG=0  # just so there isn't an error thrown when this is sourced, shoudl be overridden

function set-default-configvar() {
    local this_var=$1  # no spaces in var name
    local this_val="$2"
    local default="$3"

    # this must be shortened...
    if [ -s "$this_val" ]; then
        export $this_var=$(cat "$this_val" 2>/dev/null | head -n1 || echo "$default")
    else
        export $this_var="$default"
    fi
}

function print-env() {
    echo ""
    puts-step "Current environment:"
    env | sort | indent
    echo ""
}

function do-debug() {
    if [ $BUILD_DEBUG -gt 0 ]; then
        echo "-----> DEBUG1: $@"
    fi
}
alias do_debug='do-debug'

# Syntax sugar.
indent() {
    RE="s/^/       /"
    sed $SED_FLAG "$RE"
}

indent-debug() {
    RE="s/^/       /"
    if [ $BUILD_DEBUG -gt 0 ]; then
        sed $SED_FLAG "$RE"
    fi
}

# Clean up pip output
cleanup() {
    do-debug "Running cleanup()"
    sed $SED_FLAG -e 's/\.\.\.\+/.../g' | sed $SED_FLAG '/already satisfied/Id' | sed $SED_FLAG -e '/Overwriting/Id' |  sed $SED_FLAG -e '/python executable/Id' | sed $SED_FLAG -e '/no previously-included files/Id'
}

# Buildpack Steps.
function puts-step (){
    echo "-----> $@"
}

# Buildpack Warnings.
function puts-warn (){
    echo " !     $@"
}

# Usage: $ set-env key value
function set-env (){
    do-debug "Adding 'export $1=$2' to $PROFILE_PATH"
    echo "export $1=$2" >> $PROFILE_PATH
}

# Usage: $ set-default-env key value
function set-default-env (){
    # sets $1 to $2 if $1 isnt already set
    do-debug "Adding 'export $1=\${$1:-$2}' to $PROFILE_PATH"
    echo "export $1=\${$1:-$2}" >> $PROFILE_PATH
}

# Usage: $ set-default-env key value
function un-set-env (){
    do-debug "Adding 'unset $1' to $PROFILE_PATH"
    echo "unset $1" >> $PROFILE_PATH
}

# https://devcenter.heroku.com/articles/buildpack-api#bin-compile-summary
function export_env_dir() {
  env_dir=$1
  whitelist_regex=${2:-''}
  blacklist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
  if [ -d "$env_dir" ]; then
    for e in $(ls $env_dir); do
      echo "$e" | grep -E "$whitelist_regex" | grep -qvE "$blacklist_regex" &&
      export "$e=$(cat $env_dir/$e)"
      :
    done
  fi
}

# Does some serious copying.
function deep-cp (){
  find -H $1 -maxdepth 1 -name '.*' -a \( -type d -o -type f -o -type l \) -exec cp -a '{}' $2 \;
  cp -r $1/!(tmp) $2
}

# Does some serious moving.
function deep-mv (){
  deep-cp $1 $2

  rm -fr $1/!(tmp)
  find -H $1 -maxdepth 1 -name '.*' -a \( -type d -o -type f -o -type l \) -exec rm -fr '{}' \;
}


# Get things from CONFIG_DIR
# arg1 = file to check for, cat contents if found
# arg2 = what to echo if file not found
get-configvar() {
    # get things from CONFIG_DIR
    CHECK_FOR="$1"
    DEFAULT="$2"
    if [ -f "$CHECK_FOR" ]; then
        cat "$CHECK_FOR" | head -n1 2>/dev/null
    else
        echo "$DEFAULT"
    fi
}

# Buildpack Commands.
puts-cmd() {
  echo "     $ $@"
}


function show_files() {
    do-debug "Contents of $APP_DIR:"
    ls -Flah $APP_DIR | indent-debug || true
    do-debug "Contents of $APP_DIR/conf:"
    ls -Flah $APP_DIR/conf | indent-debug || true
    do-debug "Contents of $APP_DIR/project:"
    ls -Flah $APP_DIR/project | indent-debug || true
    do-debug "Contents of $APP_DIR/app:"
    ls -Flah $APP_DIR/app | indent-debug || true
    do-debug "Contents of $APP_DIR/public:"
    ls -Flah $APP_DIR/public | indent-debug || true
    do-debug "Contents of $APP_DIR/tmp:"
    ls -Flah $APP_DIR/tmp | indent-debug || true


    do-debug "Contents of $PACKAGEBUILDER_CACHE:"
    ls -Flah $PACKAGEBUILDER_CACHE | indent-debug || true
    do-debug "Contents of $PACKAGEBUILDER_CACHE/.linuxbrew:"
    ls -Flah $PACKAGEBUILDER_CACHE/.linuxbrew | indent-debug || true
    do-debug "Contents of $PACKAGEBUILDER_CACHE/.linuxbrew/Cellar/zlib/1.2.11/lib/pkgconfig/zlib.pc:"
    ls -Flah $PACKAGEBUILDER_CACHE/.linuxbrew/Cellar/zlib/1.2.11/lib/pkgconfig/zlib.pc | indent-debug || true
    do-debug "Contents of $PACKAGEBUILDER_CACHE/.cache:"
    ls -Flah $PACKAGEBUILDER_CACHE/.cache | indent-debug || true


    do-debug "Contents of $BIN_DIR:"
    ls -Flah $BIN_DIR | indent-debug || true
    do-debug "Contents of $BUILD_DIR:"
    ls -Flah $BUILD_DIR | indent-debug || true
    do-debug "Contents of $CONFIG_DIR:"
    ls -Flah $CONFIG_DIR | indent-debug || true


    do-debug "Contents of $CACHE_DIR:"
    ls -Flah $CACHE_DIR | indent-debug || true
    do-debug "Contents of $CACHE_DIR/.sbt_home:"
    ls -Flah $CACHE_DIR/.sbt_home | indent-debug || true
}


# Does some serious copying.
function deep_cp_subdirs(){
    #[ $BUILD_DEBUG -gt 0 ] && VERBOSE="-v" || VERBOSE=""
    VERBOSE=""
    for f in $(ls -A $1); do
#        find -H $f -maxdepth 0 -name '.*' -a \( -type d -o -type f -o -type l \) -exec cp -a '{}' $2 \;
#        find -H $f -maxdepth 1 -name '.*' -a \( -type d -o -type f -o -type l \) -exec cp -a '{}' $2 \;
        cp $VERBOSE -raf $f $2 | indent
    done
}

do-debug "Ran 'source $_'"
