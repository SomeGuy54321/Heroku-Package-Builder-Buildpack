#!/usr/bin/env bash

TARFLAGS='--use-compress-program=lz4 --sparse --check-links --same-permissions --same-owner --atime-preserve=system --delay-directory-restore'

function decompress_to_builddir() {
    local INDIR="$1"
    local BASENAME=$(basename "$INDIR")
    local DIRNAME=$(cd $(dirname "$INDIR"); pwd)
    local FULL_INDIR="$DIRNAME/$BASENAME"
    local TARFLAGS="--remove-files --overwrite $TARFLAGS"

    do-debug "Decompressing ${FULL_INDIR} into ${BUILD_DIR}"
    tar --extract               \
        --file ${FULL_INDIR} \
        $TARFLAGS \
        --directory=${BUILD_DIR} \
    |& indent
}

function compress_to_cache() {
    local INDIR="$1"
    local BASENAME=$(basename "$INDIR")
    local DIRNAME=$(cd $(dirname "$INDIR"); pwd)
    local FULL_INDIR="$DIRNAME/$BASENAME"
    local TARFLAGS=" --verify $TARFLAGS"  # --absolute-names

    do-debug "Compressing ${FULL_INDIR} to ${CACHE_DIR}/${BASENAME}.tar.lz4"
    tar --create               \
        --file ${CACHE_DIR}/${BASENAME}.tar.lz4 \
        $TARFLAGS \
        ${FULL_INDIR} \
    |& indent
}
